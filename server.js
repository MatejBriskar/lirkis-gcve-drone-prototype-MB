// Load required modules
const http = require("http"); // http server core module
const express = require("express"); // web framework external module
// const serveStatic = require("serve-static"); // serve static files
const socketIo = require("socket.io"); // web socket external module
const easyrtc = require("easyrtc"); // EasyRTC external module

// Set process name
process.title = "node-easyrtc";

// Get port or default to 8081
const port = process.env.PORT || 8081;

// Setup and configure Express http server. Expect a subfolder called "static" to be the web root.
const app = express();
app.use(express.static("public"));
app.use(express.json());

// Start Express http server
const webServer = http.createServer(app).listen(port);

// Start Socket.io so it attaches itself to Express server
// const socketServer = new socketIo.Server().listen(webServer, {"log level": 1}); // for socketio 3.0.3
const socketServer = socketIo.listen(webServer, {"log level": 1});

const myIceServers = [
    {url: "stun:stun.l.google.com:19302"},
    {url: "stun:stun1.l.google.com:19302"},
    {url: "stun:stun2.l.google.com:19302"},
    {url: "stun:stun3.l.google.com:19302"}
];

easyrtc.setOption("appIceServers", myIceServers);
easyrtc.setOption("logLevel", "debug");
easyrtc.setOption("demosEnable", false);

// Overriding the default easyrtcAuth listener, only so we can directly access its callback
easyrtc.events.on("easyrtcAuth", function (
    socket,
    easyrtcid,
    msg,
    socketCallback,
    callback
) {
    easyrtc.events.defaultListeners.easyrtcAuth(
        socket,
        easyrtcid,
        msg,
        socketCallback,
        function (err, connectionObj) {
            if (err || !msg.msgData || !msg.msgData.credential || !connectionObj) {
                callback(err, connectionObj);
                return;
            }

            connectionObj.setField("credential", msg.msgData.credential, {
                isShared: false
            });
            console.log("[" + easyrtcid + "] Credential saved!", connectionObj.getFieldValueSync("credential"));
            callback(err, connectionObj);
        }
    );
});

// To test, lets print the credential to the console for every room join!
easyrtc.events.on("roomJoin", function (
    connectionObj,
    roomName,
    roomParameter,
    callback
) {
    console.log("[" + connectionObj.getEasyrtcid() + "] Credential retrieved!", connectionObj.getFieldValueSync("credential"));
    easyrtc.events.defaultListeners.roomJoin(
        connectionObj,
        roomName,
        roomParameter,
        callback
    );
});

// Start EasyRTC server
const rtc = easyrtc.listen(app, socketServer, null, function (err, rtcRef) {
    console.log("Initiated");
    rtcRef.events.on("roomCreate", function (
        appObj,
        creatorConnectionObj,
        roomName,
        roomOptions,
        callback
    ) {
        console.log("roomCreate fired! Trying to create: " + roomName);
        appObj.events.defaultListeners.roomCreate(
            appObj,
            creatorConnectionObj,
            roomName,
            roomOptions,
            callback
        );
    });
});

//listen on port
// webServer.listen(port, function () {
//     console.log("listening on http://localhost:" + port);
// });

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////PART OF HTTP REQUEST PROCESSING////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/*** ADMIN LOGIN - check password which is retrieved from user against stored in private files
 * @filePathAdmin - path to file with admin password
 * @filePathCBot - path to file with cbot password
 * @parsedContent - parsed content to object or list of objects after read from file
 ***/
const filePathAdmin = "private/adminCredentials.json";
const filePathCBot = "private/cBotCredentials.json";
const filePathDrone = "private/droneCredentials.json";
let parsedContent;

app.post("/loginWithCredentials", function (req, res) {
    const fs = require("fs");
    if (req.body.admin !== undefined) {
        // fs.readFile(filePathAdmin, "utf8", function readFileCallback(err, data) {
        //     if (err) {
        //         console.log(err);
        //         res.sendStatus(500);
        //     } else {
        //         parsedContent = JSON.parse(data);
        //         if (parsedContent.adminPassword === req.body.admin) {
        //             res.sendStatus(200);
        //         } else {
        //             res.sendStatus(401);
        //         }
        //     }
        // });
        res.sendStatus(200);
    }
    if (req.body.cBot !== undefined) {
        fs.readFile(filePathCBot, "utf8", function readFileCallback(err, data) {
            if (err) {
                console.log(err);
                res.sendStatus(500);
            } else {
                parsedContent = JSON.parse(data);
                if (parsedContent.cBotPassword === req.body.cBot) {
                    res.sendStatus(200);
                } else {
                    res.sendStatus(401);
                }
            }
        });
    }
    if (req.body.drone !== undefined) {
        fs.readFile(filePathDrone, "utf8", function readFileCallback(err, data) {
            if (err) {
                console.log(err);
                res.sendStatus(500);
            } else {
                parsedContent = JSON.parse(data);
                if (parsedContent.dronePassword === req.body.drone) {
                    res.sendStatus(200);
                } else {
                    res.sendStatus(401);
                }
            }
        });
    }
});

/*** Send LAST 50 USERS to admin client
 * @historyUsersFilepath - path to user history json
 * @userListDTO - selected 50 newest users from file
 ***/
const historyUsersFilepath = "private/usersHistory.json";
let userListDTO;

app.get("/getUserHistory", function (req, res) {
    const fs = require("fs");
    if (req.headers.isauthenticated === "true") {
        fs.readFile(historyUsersFilepath, "utf8", function readFileCallback(
            err,
            data
        ) {
            if (err) {
                console.log(err);
                res.sendStatus(500);
            } else {
                parsedContent = JSON.parse(data); //now convert to object
                const startIndex = parsedContent.length - 50;
                if (startIndex >= 0) {
                    userListDTO = parsedContent.slice(startIndex, startIndex + 50);
                } else {
                    userListDTO = parsedContent;
                }
                res.status(200).send(userListDTO);
            }
        });
    } else {
        res.sendStatus(401);
    }
});

/*** WRITE USER INTO LIST save in private files
 * @historyUsersFilepath - path to user history json, required same as get users
 ***/
app.post("/writeUser", function (req, res) {
    const fs = require("fs");
    if (req.body && req.headers.isauthenticated === "true") {
        fs.readFile(historyUsersFilepath, "utf8", function readFileCallback(
            err,
            data
        ) {
            if (err) {
                console.log(err);
                res.sendStatus(500);
            } else {
                parsedContent = JSON.parse(data); //convert to object
                parsedContent.push(req.body); //add data
                const jsonAppend = JSON.stringify(parsedContent); //convert it back to json
                fs.writeFile(
                    historyUsersFilepath,
                    jsonAppend,
                    "utf8",
                    function callback(err) {
                        if (err) {
                            res.sendStatus(500);
                        }
                        res.sendStatus(200);
                    }
                );
            }
        });
    } else {
        res.sendStatus(401);
    }
});
