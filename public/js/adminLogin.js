/*** Script for checking admin password input before enter a scene
 * @homePage - name of html consider as main page of project use with backslash (/)
 * @attemptsLeft - number of maximum bad password input
 * @loginEndpoint - name of created endpoint on server for checking password
 * @loginEndpointUrl - complete url to validate password from server
 * @adminUsername - display admin username in scene
 * @sharedSceneId - id of scene element in HTML
 * @roomName - shared room name, where client will be connected
 * @modalLoginEnabled - toggle for modal dialog login if it is enabled
 ***/
const homePage = "/index.html";
let attemptsLeft = 5;
const loginEndpoint = "/loginWithCredentials";
const loginEndpointUrl = window.location.href.substring(0, window.location.href.lastIndexOf("/")) + loginEndpoint;
const adminUsername = "ADMIN";
const sharedSceneId = "sharedRoom";
const roomName = "basic";
const modalLoginAdminEnabled = true;

/*** Texts for bad password input ***/
const attemptsLeftText = "Wrong password! Attempts left: ";
const noAttemptsLeft = "You enter 5 times bad password. Reload the page or go to main page.";

/*** For using modal in demo, we need this elements in HTML and import CSS stylesheet modal.css
 * @modal - show modal dialog
 * @divInput - div around input
 * @passwordInput - input to type
 * @loginButton - login button
 * @wrongPasswordSpan  - space to show message
 ***/
let modal;
let passwordInput, divInput;
let wrongPasswordSpan;

function initializationAdminUsername() {
    /*** A-frame component for head-text of admin username ***/
    AFRAME.registerComponent("head-text", {
        tick: function () {
            let el = this.el;
            el.setAttribute("text", {value: adminUsername});
        }
    });
}

/*** Get all HTML elements reference after load ***/
function onLoadRefreshInterval() {
    if (modalLoginAdminEnabled === true) {
        modal = document.querySelector(".modal");
        passwordInput = document.getElementById("passwordInput");
        divInput = document.getElementById("divInput");
        wrongPasswordSpan = document.getElementById("wrongPasswordSpan");

        /*** Event listener for pressing ENTER ***/
        passwordInput.addEventListener("keyup", function (event) {
            if (event.keyCode === 13) {
                event.preventDefault();
                document.getElementById("loginButton").click();
            }
        });

        /*** Show modal dialog after initialization */
        toggleModal();
    }
}

function toggleModal() {
    modal.classList.toggle("show-modal");
}

function redirectToMainPage() {
    window.location.href = window.location.href.substring(0, window.location.href.lastIndexOf("/")) + homePage;
}

/*** Login admin to UI - send password to server and catching response
 * @password - user typed password
 ***/
function loginAdmin(password) {
    let xhr = new XMLHttpRequest();
    xhr.withCredentials = true;
    xhr.open("POST", loginEndpointUrl);
    xhr.setRequestHeader("content-type", "application/json; charset=UTF-8");
    xhr.setRequestHeader("cache-control", "no-cache");
    let userInput = {admin: password};
    xhr.send(JSON.stringify(userInput));

    xhr.onload = function () {
        let responseObj = xhr.response;
        if (responseObj === "OK") {
            if (modalLoginAdminEnabled === true) {
                toggleModal();
            }
            console.info("Password verified successfully");
            joinRoom(sharedSceneId);
        } else {
            if (
                divInput !== undefined &&
                wrongPasswordSpan !== undefined &&
                modalLoginAdminEnabled === true
            ) {
                styleBadInput();
            }
            attemptsLeft--;
            if (attemptsLeft === 0) {
                noAttemptsLeftDialog(wrongPasswordSpan, noAttemptsLeft, true);
            } else {
                badAttemptDialog(wrongPasswordSpan, attemptsLeftText, attemptsLeft);
            }
        }
    };
}

/*** Styles around input and text***/
function styleBadInput() {
    if (!divInput.classList.contains("wrong-input-border")) {
        divInput.classList.add("wrong-input-border");
    }
    if (wrongPasswordSpan.classList.contains("hidden")) {
        wrongPasswordSpan.classList.toggle("hidden");
    }
    wrongPasswordSpan.innerHTML = "";
}

/*** Show message that user type wrong password
 * @spanToShow - span to show message - message and attempts left are on beginning
 * @message - message to be shown
 * @numberOfAttempts - number of attempts left
 ***/
function badAttemptDialog(spanToShow, message, numberOfAttempts) {
    if (modalLoginAdminEnabled === true && spanToShow) {
        spanToShow.innerHTML = message + numberOfAttempts;
    } else {
        console.warn(message + numberOfAttempts);
    }
}

/*** Function to hide elements and show message that user ran out of attempts
 * @spanToShow - span to show message
 * @message - message to be shown
 * @hideInput - Boolean - decide if hide input and login button
 ***/
function noAttemptsLeftDialog(spanToShow, message, hideInput) {
    if (modalLoginAdminEnabled === true && spanToShow) {
        spanToShow.innerHTML = message;
        if (hideInput) {
            divInput.classList.add("hidden");
            document.getElementById("loginButton").classList.add("hidden");
        }
    } else {
        console.error(message);
    }
}

/*** Join user to shared room
 * @sceneId - id of scene which should be shared
 ***/
function joinRoom(sceneId) {
    let scene = document.getElementById(sceneId);
    /*** Setup networked-scene ***/
    let networkedComp = {
        room: roomName,
        debug: true,
        transport: "websocket",
        onConnected: "onConnect",
        adapter: "easyrtc"
    };
    console.info("Init networked-aframe with settings:", networkedComp);
    scene.setAttribute("networked-scene", networkedComp);
}

initializationAdminUsername();
