let gpHand, gpClicker, player;
let isGrabbedHololens = false;
let handStartPosition = null;
let handEndPosition = null;
let AFRAME = AFRAME || {};
let CANNON = CANNON || {};

function buttonPressedHoloLens (gamepad) {
    return !!(gamepad && gamepad.connected && gamepad.buttons[0].pressed);
}

// COMPONENT - TAP AND DRAG OBJECT USING HAND
AFRAME.registerComponent("tap-and-drag", {
    init: function () {
        window.addEventListener("gamepadconnected", function () {
            let gamepads = navigator.getGamepads ? navigator.getGamepads() : navigator.webkitGetGamepads ? navigator.webkitGetGamepads : [];
            gpHand = gamepads[4];
            gpClicker = gamepads[6];
        });

        this.el.addEventListener("raycaster-intersected", evt => {
            this.raycaster = evt.detail.el;
            this.el.setAttribute("material", "opacity", "0.5");
        });

        this.el.addEventListener("raycaster-intersected-cleared", evt => {
            this.el.setAttribute("material", "opacity", "1");
            this.raycaster = null;
        });

        player = document.querySelector("#playerhead");
    },

    tick: function () {
        if (!this.raycaster) {
            return;
        }
        let intersection = this.raycaster.components.raycaster.getIntersection(
            this.el
        );
        if (!intersection) {
            return;
        }
        if (intersection) {
            if (buttonPressedHoloLens(gpHand)) {
                let gpPosX = gpHand.pose.position[0];
                let gpPosY = gpHand.pose.position[1];
                let gpPosZ = gpHand.pose.position[2];
                let playerPosition = player.getAttribute("position");

                if (!handStartPosition) {
                    handStartPosition = [gpPosX, gpPosY, gpPosZ];
                }
                handEndPosition = [gpPosX, gpPosY, gpPosZ];
            } else {
                this.watchHandState(this.el);
            }
        }
    },

    watchHandState: function (el) {
        if (handStartPosition) {
            let elStartPos = el.getAttribute("position");
            let offsetX = elStartPos.x + (handEndPosition[0] - handStartPosition[0]);
            let offsetY = elStartPos.y + (handEndPosition[1] - handStartPosition[1]);
            let offsetZ = elStartPos.z + (handEndPosition[2] - handStartPosition[2]);
            el.object3D.position.set(offsetX, offsetY, offsetZ);
            handStartPosition = null;
            handEndPosition = null;
            offsetX = 0;
            offsetZ = 0;
            offsetX = 0;
        }
    }
});

//COMPONENT - LOOK, CLICK AND MOVE OBJECT USING CLICKER
AFRAME.registerComponent("click-and-push", {
    init: function () {
        window.addEventListener("gamepadconnected", function () {
            let gamepads = navigator.getGamepads ? navigator.getGamepads() : navigator.webkitGetGamepads ? navigator.webkitGetGamepads : [];
            gpHand = gamepads[4];
            gpClicker = gamepads[6];
        });

        this.system = this.el.sceneEl.systems.physics;
        this.grabbing = false;
        this.hitEl = /** @type {AFRAME.Element}    */ null;
        this.physics = /** @type {AFRAME.System}     */ this.el.sceneEl.systems.physics;
        this.constraint = /** @type {CANNON.Constraint} */ null;
        this.grabbed = false;
        this.gripButtonpushed = false;
        this.loop = 0;

        this.el.addEventListener("raycaster-intersected", event => {
            if (buttonPressedHoloLens(gpHand)) {
                this.gripButtonpushed = true;

                if (this.grabbed === false && this.gripButtonpushed === true) {
                    let parentObject = document.querySelector("#usercursor"); // parent object with which the child will be constrained
                    this.constraint = new CANNON.LockConstraint(
                        this.el.body,
                        parentObject.body,
                        {maxForce: 5000}
                    );
                    this.system.addConstraint(this.constraint);
                    this.grabbed = true;
                }
            }
        });

        this.el.addEventListener("raycaster-intersected-cleared", event => {
            if (buttonPressedHoloLens(gpHand)) {
                this.system.removeConstraint(this.constraint);
                this.grabbed = false;
                this.gripButtonpushed = false;
            }
        });
    }
});
