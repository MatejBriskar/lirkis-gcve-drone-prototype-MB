/*** Script for receiving messages for disconnect client
 * @Data channel which provide kick of user
 * @dataChannelToKick - datachannel receiving kick message, must match with admin client kick datachannel
 * @adminSecretBroadcastChannel - datachannel for sharing part of admin ID, integrity that only Admin can kick me - must match with admin client datachannel
 * @adminSecretId - secret ID string long 10 characters, linked with admin NAF id, so only admin can kick user
 ***/
const dataChannelToKick = "disconnect";
const adminSecretBroadcastChannel = "adminSecret";
let adminSecretId;

function initializationUserComponent() {
    AFRAME.registerComponent("subscribe-to-receive-kick-message", {
        init: function () {
            /*** Create subscription to data channels after connecting scene ***/
            document.body.addEventListener("connected", function (evt) {
                /*** Subscribe to chanel to get adminSecret so only admin should kick me ***/
                NAF.connection.subscribeToDataChannel(
                    adminSecretBroadcastChannel,
                    function (senderId, dataType, data, targetId) {
                        adminSecretId = data;
                    }
                );

                /*** Subscribe to data channel, after receive message execute function disconnectUser ***/
                NAF.connection.subscribeToDataChannel(dataChannelToKick, function (
                    senderId,
                    dataType,
                    data,
                    targetId
                ) {
                    if (senderId.toString().slice(0, 10) === adminSecretId && data === "kick") {
                        disconnectClient();
                    }
                });
            });
        }
    });

    AFRAME.registerComponent('user-ui', {
        init: function () {
            this.uiText = document.getElementById('user-text');

            this.targets = document.getElementsByClassName('user-target');

            for (let i = 0; i < this.targets.length; i++) {
                this.targets[i].id = 'user-target-id' + i;
            }

            this.uiText.innerText = 'Find all ' + this.targets.length + ' targets';

            this.foundTargets = [];
        },

        addTarget: function (target) {
            let found = false;

            for (let i = 0; i < this.foundTargets.length; i++) {
                if (this.foundTargets[i].id === target.id) {
                    found = true;
                    break;
                }
            }

            if (found) return;

            this.foundTargets.push(target);

            if (this.foundTargets.length === this.targets.length) {
                this.uiText.innerText = 'You have found all targets!\nWell done';
            } else {
                this.uiText.innerText = 'You have found ' + this.foundTargets.length + '/' + this.targets.length + ' targets';
            }
        }
    });

    AFRAME.registerComponent('user-target', {
        init: function () {
            this.userEl = document.getElementById('rig');

            this.onHitStart = this.onHitStart.bind(this);
            this.el.addEventListener('hitstart', this.onHitStart);
        },

        onHitStart: function (e) {
            this.userEl.components['user-ui'].addTarget(this.el);
        },

        remove: function () {
            this.el.removeEventListener('hitstart', this.onHitStart);
        }
    });
}

/*** Disconnect client who receive message ***/
function disconnectClient() {
    NAF.connection.disconnect();
    console.warn("You were kicked from scene!");
}

initializationUserComponent();
