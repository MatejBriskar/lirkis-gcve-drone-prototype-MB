/*** Script for username input before enter a scene
 * @basicUrl - basic URL of project
 * @homePage - name of html consider as main page of project use with backslash (/)
 * @sharedSceneId - id of scene from HTML where user should be connected
 * @roomName - shared room name, where client will be connected
 * @maxLengthOfUsername - number of maximum length of username in scene
 * @modalLoginEnabled - toggle for modal dialog login if it is enabled
 * @notAllowedAdminUsername - not allowed username Admin
 * @notAllowedCBotUsername - not allowed username Cbot
 ***/
const basicUrl = window.location.href.substring(0, window.location.href.lastIndexOf("/"));
const homePage = "/index.html";
const sharedSceneId = "sharedRoom";
const roomName = "basic";
const maxLengthOfUsername = 10;
const modalLoginEnabledUser = true;
const notAllowedAdminUsername = "admin";
const notAllowedCBotUsername = "cbot";
const notAllowedDroneUsername = "drone";

/*** Texts for user bad input ***/
const emptyInput = "Username can not be empty!";
const blankSpaces = "Username can not contain any blank space!";
const tooLongUsername = "Username can not be longer than " + maxLengthOfUsername + " characters!";
const notAllowedUsername = "This username is not allowed!";

/*** For using modal in demo, we need this elements in HTML and import CSS stylesheet modal.css
 * @modal - show modal dialog
 * @usernameInput -  input for username
 * @divInput - for handling username violation
 * @loginButton - trigger after click validation of username and room connection
 * @wrongUsername @wrongUsernameText - handles invalid username
 ***/
let modal;
let usernameInput, divInput;
let loginButton;
let wrongUsername, wrongUsernameText;

function initializationUserLoginComponent() {
    /*** A-frame component for head-text of client username ***/
    AFRAME.registerComponent("head-text", {
        tick: function () {
            const el = this.el;
            el.setAttribute("text", {value: getUserName()});
        }
    });
}

/*** Get all HTML elements reference after load ***/
function onLoadRefreshInterval() {
    if (modalLoginEnabledUser === true) {
        modal = document.getElementById("modalDialog");
        usernameInput = document.getElementById("usernameInput");
        divInput = document.getElementById("divInput");
        loginButton = document.getElementById("loginButton");
        wrongUsername = document.getElementById("wrongUsername");
        wrongUsernameText = document.getElementById("wrongUsernameText");

        /*** Event listener for pressing ENTER ***/
        usernameInput.addEventListener("keyup", function (event) {
            if (event.isComposing || event.keyCode === 229) {
                return;
            }
            if (event.keyCode === 13) { // Enter
                event.preventDefault();
                loginButton.click();
            }
        });

        /*** Show modal dialog after initialization */
        toggleModal();
    } else {
        joinRoom(sharedSceneId);
    }
}

/*** Toggle show modal class to modal dialog - show/hide modal ***/
function toggleModal() {
    modal.classList.toggle("show-modal");
}

function redirectToMainPage() {
    window.location.href = basicUrl + homePage;
}

/*** Function for parsing username of guest
 * @username - String - input parameter from userInput field in modal dialog
 ***/
function enterSceneGuest(username) {
    const lowerCaseUsername = username.toLowerCase();
    if (
        username.length > 0 &&
        username.length <= maxLengthOfUsername &&
        username.indexOf(" ") === -1 &&
        lowerCaseUsername !== notAllowedAdminUsername &&
        lowerCaseUsername !== notAllowedCBotUsername &&
        lowerCaseUsername !== notAllowedDroneUsername &&
        !lowerCaseUsername.includes(notAllowedAdminUsername) &&
        !lowerCaseUsername.includes(notAllowedCBotUsername) &&
        !lowerCaseUsername.includes(notAllowedDroneUsername)
    ) {

        if (modalLoginEnabledUser) {
            toggleModal();
        }

        setUserName(username);
        joinRoom(sharedSceneId);
    } else {
        if (
            divInput !== undefined &&
            wrongUsername !== undefined &&
            wrongUsernameText !== undefined &&
            modalLoginEnabledUser
        ) {
            styleBadInput();
        }
        /*** Handle bad input cases ***/
        showUsernameValidationRestriction(wrongUsernameText, notAllowedUsername);

        if (username.length === 0) {
            showUsernameValidationRestriction(wrongUsernameText, emptyInput);
        }
        if (username.indexOf(" ") !== -1) {
            showUsernameValidationRestriction(wrongUsernameText, blankSpaces);
        }
        if (username.length > maxLengthOfUsername) {
            showUsernameValidationRestriction(wrongUsernameText, tooLongUsername);
        }
    }
}

/*** Function to show one validation message
 * @spanToShow - String - span element for showing message
 * @message - String - message to show
 ***/
function showUsernameValidationRestriction(spanToShow, message) {
    if (spanToShow && modalLoginEnabledUser) {
        spanToShow.innerHTML = message;
    } else {
        console.error(message);
    }
}

/*** Styles around input and text***/
function styleBadInput() {
    if (!divInput.classList.contains("wrong-input-border")) {
        divInput.classList.add("wrong-input-border");
    }
    if (wrongUsername.classList.contains("hidden")) {
        wrongUsername.classList.toggle("hidden");
    }
    wrongUsernameText.innerHTML = "";
}

function setUserName(username) {
    this.username = username;
}

function getUserName() {
    return this.username;
}

/*** Join user to shared room
 * @sceneId - String - id of scene which should be shared
 ***/
function joinRoom(sceneId) {
    const scene = document.getElementById(sceneId);
    /*** Setup networked-scene ***/
    const networkedComp = {
        room: roomName,
        debug: true,
        transport: "websocket",
        onConnected: "onConnect",
        adapter: "easyrtc"
    };

    console.info("Init shared scene with settings:", networkedComp);
    scene.setAttribute("networked-scene", networkedComp);
}

initializationUserLoginComponent();
